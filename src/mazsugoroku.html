<html>

<head>
<title>mazsugoroku</title>
<script src="/socket.io/socket.io.js"></script>
<script>

	// å¤šåˆ†ãŠã¾ã˜ãªã„çš„ãªã‚„ã¤
	const socket = io();
	
	let playerName = ['', ''];
	let traveled = [0, 0];
	
	// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®èª­ã¿è¾¼ã¿ãŒçµ‚ã‚ã£ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹
	window.onload = function() {
	
		//é€ä¿¡ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ãŠã
		document.getElementById('loginButton').onclick = function() {

			// ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’å–å¾—
			let inputName = document.getElementById('inputText').value;

			// ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ãŒç©ºãªã‚‰ä¸­æ­¢
			if (inputName === '') {
				return;
			}

			// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ç”¨ã®ã‚½ã‚±ãƒƒãƒˆé€šä¿¡ã‚’æŠ•ã’ã‚‹
			socket.emit('mazsugoroku_login_request', inputName);
			
		};
		
		// ãƒœã‚¿ãƒ³ã«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ã‚’è¨­å®šã™ã‚‹
		document.getElementById("rollDice").onclick = function() {

			let deme = Math.ceil(Math.random()*6);
			document.getElementById("deme").textContent = deme;
			let playerIndex = playerName.indexOf(document.getElementById('inputText').value);
			traveled[playerIndex] += deme;
			refresh();
			let json = JSON.stringify({playerName: playerName, traveled: traveled});
			socket.emit('mazsugoroku_rollDice', json);
		}
		
		refresh();
	}
	
	function refresh() {
		// èƒŒæ™¯
		drawRect(0, 0, 1280, 720, '#dec');
		
		// ã¾ã™
		for(let i = 0; i < 15; i++){
			drawRect(40 + i * 80, 40, 40, 40, '#48c');
		}
		
		// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
		drawText('ğŸ‘¨â€ğŸ«', 40 + traveled[0] * 80, 60, '#000');
		drawText('ğŸ‘¨â€ğŸ”§', 40 + traveled[1] * 80, 100, '#000');
		
	}
	
	function drawRect(x, y, width, height, fillStyle) {
		var canvas = document.getElementById("canvas");
		var context = canvas.getContext("2d");
		context.fillStyle = fillStyle;
		context.fillRect(x, y, width, height);
	}
	
	function drawText(text, x, y, fillStyle) {
		var context = document.getElementById('canvas').getContext('2d');
		context.font = '48px serif';
		context.fillStyle = fillStyle;
		context.fillText(text, x, y);
	}
	
	// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å—ä¿¡å‡¦ç†
	socket.on('mazsugoroku_login_response', (message) => {
		
		// å—ã‘å–ã£ãŸJSONã‚’è§£èª­ã™ã‚‹
		let responseDataParsed = JSON.parse(message);
		
		playerName = responseDataParsed.playerName;
		document.getElementById("playerName0").textContent = playerName[0];
		document.getElementById("playerName1").textContent = playerName[1];
		
	});

	// ã•ã„ã“ã‚æŒ¯ã£ãŸå¾Œã®å—ä¿¡å‡¦ç†
	socket.on('mazsugoroku_rollDice_reflected', (message) => {
		
		// å—ã‘å–ã£ãŸJSONã‚’è§£èª­ã™ã‚‹
		let responseDataParsed = JSON.parse(message);
		
		playerName = responseDataParsed.playerName;
		document.getElementById("playerName0").textContent = playerName[0];
		document.getElementById("playerName1").textContent = playerName[1];
		traveled = responseDataParsed.traveled;
		document.getElementById("traveled0").textContent = traveled[0];
		document.getElementById("traveled1").textContent = traveled[1];
		refresh();
	});


</script>

</head>

<body>

<h1>mazsugoroku</h1>

<div>
	<input id="inputText" type="text">
	<button type="button" id = "loginButton">ç€å¸­</button>
</div>

<canvas id="canvas" width="1280" height="720"></canvas>

<table border="1" bgcolor="#cccccc">
  <tr><th>id</th><th>çŠ¶æ…‹</th><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</th><th>ç§»å‹•è·é›¢</th></tr>
  <tr><td>1</td><td id="playerState0"></td><td id="playerName0">(ç©ºå¸­)</td><td id="traveled0">0</td></tr>
  <tr><td>2</td><td id="playerState1"></td><td id="playerName1">(ç©ºå¸­)</td><td id="traveled1">0</td></tr>
</table>

<div>
	<button type="button" id = "rollDice">ã•ã„ã“ã‚ã‚’æŒ¯ã‚‹</button>
	<span id="deme"></span>
</div>

</body>
</html>

